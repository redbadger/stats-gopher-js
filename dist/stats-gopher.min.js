function StatsGopher(e){if(e=e||{},"function"!=typeof e.ajax)throw new Error("no 'ajax' function specified in options");if("function"!=typeof e.Deferred)throw new Error("no 'Deferred' constructor specified in options");if("string"!=typeof e.endpoint)throw new Error("no 'endpoint' option specified");this.options=e,this.buffer=[],this.sid=StatsGopher.sid(),this.interval=e.interval||100}StatsGopher.prototype={send:function(e){return e.sendTime=(new Date).valueOf(),e.sid=this.sid,this.startBuffer(),this.buffer.push(e),this.deferred.promise()},startBuffer:function(){"timeout"in this||(this.timeout=setTimeout(this.onTimeout.bind(this),this.interval),this.deferred=new this.options.Deferred)},flush:function(){var e=this.buffer;return this.buffer=[],e},onTimeout:function(){var e=this.flush(),t=this.options,n=this.deferred;return delete this.deferred,delete this.timeout,this.options.ajax({type:"POST",url:t.endpoint,data:JSON.stringify(e),dataType:"text",cache:!1}).done(function(){n.resolve()}.bind(this)).fail(function(){n.reject()}.bind(this))}},StatsGopher.generateSid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})},StatsGopher.sid=function(){if(this.docCookie.hasItem("sg-sid"))return this.docCookie.getItem("sg-sid");var e=this.generateSid();return this.docCookie.setItem("sg-sid",e),e},StatsGopher.docCookie={getItem:function(e){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,t,n,o,i,r){if(!e||/^(?:expires|max\-age|path|domain|secure)$/i.test(e))return!1;var s="";if(n)switch(n.constructor){case Number:s=1/0===n?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+n;break;case String:s="; expires="+n;break;case Date:s="; expires="+n.toUTCString()}return document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t)+s+(i?"; domain="+i:"")+(o?"; path="+o:"")+(r?"; secure":""),!0},removeItem:function(e,t,n){return e&&this.hasItem(e)?(document.cookie=encodeURIComponent(e)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(n?"; domain="+n:"")+(t?"; path="+t:""),!0):!1},hasItem:function(e){return new RegExp("(?:^|;\\s*)"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},keys:function(){for(var e=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),t=0;t<e.length;t++)e[t]=decodeURIComponent(e[t]);return e}};
StatsGopher.PresenceMonitor=function(t){t=t||{},this.statsGopher=t.statsGopher,this.key=t.key,this.send=this.executeNextSend,this.paused=!1},StatsGopher.PresenceMonitor.prototype={ignoreNextSend:function(){},queueNextSend:function(){this.request.done(function(){this.send()}.bind(this)),this.send=this.ignoreNextSend},executeNextSend:function(){var t=function(){this.send=this.executeNextSend}.bind(this);this.paused||(this.request=this.statsGopher.send({code:this.code,key:this.key}).done(t).fail(t),this.send=this.queueNextSend)},pause:function(){this.paused=!0},resume:function(){this.paused=!1}},StatsGopher.Heartbeat=function(t){StatsGopher.PresenceMonitor.apply(this,arguments),this.timeout="number"==typeof t.timeout?t.timeout:1e4},StatsGopher.Heartbeat.prototype=new StatsGopher.PresenceMonitor,StatsGopher.Heartbeat.prototype.code="heartbeat",StatsGopher.Heartbeat.prototype.start=function(){this.send(),setTimeout(this.start.bind(this),1e4)},StatsGopher.UserActivity=function(){StatsGopher.PresenceMonitor.apply(this,arguments)},StatsGopher.UserActivity.prototype=new StatsGopher.PresenceMonitor,StatsGopher.UserActivity.prototype.code="user-activity",StatsGopher.UserActivity.prototype.listen=function(){var t=["pageshow","popstate","resize","click","mousedown","scroll","mousemove","keydown"];t.forEach(function(t){window.addEventListener(t,function(){this.send()}.bind(this))}.bind(this))};